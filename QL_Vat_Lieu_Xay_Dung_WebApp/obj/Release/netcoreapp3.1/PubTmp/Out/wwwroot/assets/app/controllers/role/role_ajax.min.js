var role_ajax=function(){function i(){$("#frmMaintainance").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtName:{required:!0}}});$("#txt-search-keyword").keypress(function(t){t.which===13&&(t.preventDefault(),n())});$("#btn-search").on("click",function(){n()});$("#ddl-show-page").on("change",function(){app.configs.pageSize=$(this).val();app.configs.pageIndex=1;n(!0)});$("#btn-create").on("click",function(){t();$("#modal-add-edit").modal("show")});$("body").on("click",".btn-edit",function(n){n.preventDefault();var t=$(this).data("id");$.ajax({type:"GET",url:"/Admin/Role/GetById",data:{id:t},dataType:"json",beforeSend:function(){app.startLoading()},success:function(n){var t=n;$("#hidId").val(t.Id);$("#txtName").val(t.Name);$("#txtDescription").val(t.Description);$("#modal-add-edit").modal("show");app.stopLoading()},error:function(){app.notify("Có lỗi xảy ra","error");app.stopLoading()}})});$("#btnSave").on("click",function(i){if($("#frmMaintainance").valid()){i.preventDefault();var r=$("#hidId").val(),u=$("#txtName").val(),f=$("#txtDescription").val();$.ajax({type:"POST",url:"/Admin/Role/SaveEntity",data:{Id:r,Name:u,Description:f},dataType:"json",beforeSend:function(){app.startLoading()},success:function(){app.notify("Cập nhật thành công","success");$("#modal-add-edit").modal("hide");t();app.stopLoading();n(!0)},error:function(){app.notify("Có lỗi trong quá trình cập nhật","error");app.stopLoading()}})}return!1});$("body").on("click",".btn-delete",function(t){t.preventDefault();var i=$(this).data("id");app.confirm("Bạn Có Chắc Chắn Muốn Xóa Chứ?",function(){$.ajax({type:"POST",url:"/Admin/Role/Delete",data:{id:i},beforeSend:function(){app.startLoading()},success:function(){app.notify("Xóa Thành Công","success");app.stopLoading();n(!0)},error:function(){app.notify("Có Lỗi Trong Quá Trình Xóa","error");app.stopLoading()}})})});$("body").on("click",".btn-grant",function(){$("#hidRoleId").val($(this).data("id"));$.when(r()).done(u($("#hidRoleId").val()));$("#modal-grantpermission").modal("show")});$("#btnSavePermission").off("click").on("click",function(){var n=[];$.each($("#tblFunction tbody tr"),function(t,i){n.push({RoleId:$("#hidRoleId").val(),FunctionId:$(i).data("id"),CanRead:$(i).find(".ckView").first().prop("checked"),CanCreate:$(i).find(".ckAdd").first().prop("checked"),CanUpdate:$(i).find(".ckEdit").first().prop("checked"),CanDelete:$(i).find(".ckDelete").first().prop("checked")})});$.ajax({type:"POST",url:"/Admin/Role/SavePermission",data:{listPermission:n,roleId:$("#hidRoleId").val()},beforeSend:function(){app.startLoading()},success:function(){app.notify("Save permission successful","success");$("#modal-grantpermission").modal("hide");app.stopLoading()},error:function(){app.notify("Has an error in save permission progress","error");app.stopLoading()}})})}function r(n){return $.ajax({type:"GET",url:"/Admin/Function/GetAll",dataType:"json",beforeSend:function(){app.startLoading()},success:function(t){var r=$("#result-data-function").html(),i="";$.each(t,function(n,t){i+=Mustache.render(r,{Name:t.Name,treegridparent:t.ParentId!=null?"treegrid-parent-"+t.ParentId:"",Id:t.Id,AllowCreate:t.AllowCreate?"checked":"",AllowEdit:t.AllowEdit?"checked":"",AllowView:t.AllowView?"checked":"",AllowDelete:t.AllowDelete?"checked":"",Status:app.getStatus(t.Status)})});i!=undefined&&$("#lst-data-function").html(i);$(".tree").treegrid();$("#ckCheckAllView").on("click",function(){$(".ckView").prop("checked",$(this).prop("checked"))});$("#ckCheckAllCreate").on("click",function(){$(".ckAdd").prop("checked",$(this).prop("checked"))});$("#ckCheckAllEdit").on("click",function(){$(".ckEdit").prop("checked",$(this).prop("checked"))});$("#ckCheckAllDelete").on("click",function(){$(".ckDelete").prop("checked",$(this).prop("checked"))});$(".ckView").on("click",function(){$(".ckView:checked").length==t.length?$("#ckCheckAllView").prop("checked",!0):$("#ckCheckAllView").prop("checked",!1)});$(".ckAdd").on("click",function(){$(".ckAdd:checked").length==t.length?$("#ckCheckAllCreate").prop("checked",!0):$("#ckCheckAllCreate").prop("checked",!1)});$(".ckEdit").on("click",function(){$(".ckEdit:checked").length==t.length?$("#ckCheckAllEdit").prop("checked",!0):$("#ckCheckAllEdit").prop("checked",!1)});$(".ckDelete").on("click",function(){$(".ckDelete:checked").length==t.length?$("#ckCheckAllDelete").prop("checked",!0):$("#ckCheckAllDelete").prop("checked",!1)});n!=undefined&&n();app.stopLoading()},error:function(n){console.log(n)}})}function u(n){return $.ajax({type:"POST",url:"/Admin/Role/ListAllFunction",data:{roleId:n},dataType:"json",beforeSend:function(){app.stopLoading()},success:function(n){var t=n;$.each($("#tblFunction tbody tr"),function(n,i){$.each(t,function(n,t){t.FunctionId===$(i).data("id")&&($(i).find(".ckView").first().prop("checked",t.CanRead),$(i).find(".ckAdd").first().prop("checked",t.CanCreate),$(i).find(".ckEdit").first().prop("checked",t.CanUpdate),$(i).find(".ckDelete").first().prop("checked",t.CanDelete))})});$(".ckView:checked").length===$("#tblFunction tbody tr .ckView").length?$("#ckCheckAllView").prop("checked",!0):$("#ckCheckAllView").prop("checked",!1);$(".ckAdd:checked").length===$("#tblFunction tbody tr .ckAdd").length?$("#ckCheckAllCreate").prop("checked",!0):$("#ckCheckAllCreate").prop("checked",!1);$(".ckEdit:checked").length===$("#tblFunction tbody tr .ckEdit").length?$("#ckCheckAllEdit").prop("checked",!0):$("#ckCheckAllEdit").prop("checked",!1);$(".ckDelete:checked").length===$("#tblFunction tbody tr .ckDelete").length?$("#ckCheckAllDelete").prop("checked",!0):$("#ckCheckAllDelete").prop("checked",!1);app.stopLoading()},error:function(n){console.log(n)}})}function t(){$("#hidId").val("");$("#txtName").val("");$("#txtDescription").val("")}function n(t){$.ajax({type:"GET",url:"/admin/role/GetAllPaging",data:{keyword:$("#txt-search-keyword").val(),page:app.configs.pageIndex,pageSize:app.configs.pageSize},dataType:"json",beforeSend:function(){app.startLoading()},success:function(i){var u=$("#table-template").html(),r="";i.RowCount>0?($.each(i.ResultList,function(n,t){r+=Mustache.render(u,{Name:t.Name,Id:t.Id,Description:t.Description})}),$("#lbl-total-records").text(i.RowCount),r!=undefined&&$("#tbl-content").html(r),f(i.RowCount,function(){n()},t)):$("#tbl-content").html("");app.stopLoading()},error:function(n){console.log(n)}})}function f(n,t,i){var r=Math.ceil(n/app.configs.pageSize);($("#paginationUL a").length===0||i===!0)&&($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:r,visiblePages:7,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(n,i){app.configs.pageIndex=i;setTimeout(t(),200)}})}this.initialize=function(){n();i()}};