var bill_ajax=function(){function f(){$("#txtFromDate, #txtToDate").datepicker({autoclose:!0,format:"dd/mm/yyyy"});$("#frmMaintainance").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtCustomerName:{required:!0},txtCustomerAddress:{required:!0},txtCustomerMobile:{required:!0},txtCustomerMessage:{required:!0},ddlBillStatus:{required:!0}}});$("#txt-search-keyword").keypress(function(n){n.which===13&&(n.preventDefault(),t())});$("#btn-search").on("click",function(){t()});$("#btn-create").on("click",function(){u();$("#modal-detail").modal("show")});$("#ddl-show-page").on("change",function(){app.configs.pageSize=$(this).val();app.configs.pageIndex=1;t(!0)});$("body").on("click",".btn-view",function(n){n.preventDefault();var t=$(this).data("id");$.ajax({type:"GET",url:"/Admin/Bill/GetById",data:{id:t},beforeSend:function(){app.startLoading()},success:function(n){var t=n,u,e,f,o;$("#hidId").val(t.Id);$("#txtCustomerName").val(t.CustomerName);$("#hidDateCreated").val(t.DateCreated);$("#txtCustomerAddress").val(t.CustomerAddress);$("#txtCustomerMobile").val(t.CustomerMobile);$("#txtCustomerMessage").val(t.CustomerMessage);$("#ddlPaymentMethod").val(t.PaymentMethod);$("#hidCustomerId").val(t.CustomerId);$("#ddlBillStatus").val(t.BillStatus);u=[];e=t.BillDetails;t.BillDetails!=null&&t.BillDetails.length>0&&(f="",o=$("#template-table-bill-details").html(),$.each(e,function(n,t){var i=r(t.ProductId);u.push({Id:t.Id,ProductId:t.ProductId,SizeId:t.SizeId});f+=Mustache.render(o,{Id:t.Id,Products:i,Quantity:t.Quantity});$("#tbl-bill-details").html(f)}),$.each(u,function(n,t){var r=$('[data-id="'+t.Id+'"]').find(".ddlSizeId");r.removeAttr("disabled");i(r,t.ProductId,t.SizeId)}));$("#modal-detail").modal("show");app.stopLoading()},error:function(){app.notify("Has an error in progress","error");app.stopLoading()}})});$("#btnSave").on("click",function(n){if($("#frmMaintainance").valid()){n.preventDefault();var i=$("#hidId").val(),f=$("#txtCustomerName").val(),e=$("#txtCustomerAddress").val(),o=$("#txtCustomerMobile").val(),s=$("#txtCustomerMessage").val(),h=$("#ddlPaymentMethod").val(),c=$("#ddlBillStatus").val(),l=$("#hidDateCreated").val(),a=$("#hidCustomerId").val(),r=[];return $.each($("#tbl-bill-details tr"),function(n,t){r.push({Id:$(t).data("id"),ProductId:$(t).find("select.ddlProductId").first().val(),Quantity:$(t).find("input.txtQuantity").first().val(),SizeId:$(t).find("select.ddlSizeId").first().val(),BillId:i})}),$.ajax({type:"POST",url:"/Admin/Bill/SaveEntity",data:{Id:i,BillStatus:c,CustomerAddress:e,CustomerId:a,CustomerMessage:s,CustomerMobile:o,CustomerName:f,DateCreated:l,PaymentMethod:h,Status:1,BillDetails:r},dataType:"json",beforeSend:function(){app.startLoading()},success:function(){app.notify("Save order successful","success");$("#modal-detail").modal("hide");u();app.stopLoading();t(!0)},error:function(){app.notify("Has an error in progress","error");app.stopLoading()}}),!1}return!1});$("#btnAddDetail").on("click",function(){var n=$("#template-table-bill-details").html(),t=r(null),i=Mustache.render(n,{Id:0,Products:t,Quantity:0,Total:0});$("#tbl-bill-details").append(i)});$("body").on("click",".btn-delete-detail",function(){$(this).parent().parent().remove()});$("body").on("change",".ddlProductId",function(){var n=$(this).closest("tr").find(".ddlSizeId");n.removeAttr("disabled");i(n,$(this).val(),null)})}function i(n,t,i){return $.ajax({type:"GET",url:"/Admin/ProductReceipt/GetReceiptDetailsByProductId",data:{id:parseInt(t)},DaType:"json",success:function(t){var r="<option value = ''>=== Select Size ===<\/option>";$.each(t,function(t,u){r+=i===u.Size.Id?'<option value="'+u.Size.Id+'" selected="select">'+u.Size.Name+"<\/option>":'<option value="'+u.Size.Id+'">'+u.Size.Name+"<\/option>";$(n).html(r)})},error:function(){app.notify("Has an error in progress","error")}})}function e(){return $.ajax({type:"GET",url:"/admin/bill/GetBillStatus",dataType:"json",success:function(t){n.billStatuses=t;var i="";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlBillStatus").html(i)}})}function o(){return $.ajax({type:"GET",url:"/admin/bill/GetPaymentMethod",dataType:"json",success:function(t){n.paymentMethods=t;var i="";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlPaymentMethod").html(i)}})}function s(){return $.ajax({type:"GET",url:"/Admin/Product/GetAll",dataType:"json",success:function(t){n.products=t},error:function(){app.notify("Has an error in progress","error")}})}function r(t){var i="<select required class='form-control ddlProductId'>";return i+="<option value = ''>=== Select Product ===<\/option>",$.each(n.products,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function u(){$("#hidId").val(0);$("#txtCustomerName").val("");var n=new Date,t=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();$("#hidDateCreated").val(t);$("#txtCustomerAddress").val("");$("#txtCustomerMobile").val("");$("#txtCustomerMessage").val("");$("#ddlPaymentMethod").val("");$("#ddlBillStatus").val("");$("#tbl-bill-details").html("")}function t(n){$.ajax({type:"GET",url:"/admin/bill/GetAllPaging",data:{startDate:$("#txtFromDate").val(),endDate:$("#txtToDate").val(),keyword:$("#txtSearchKeyword").val(),page:app.configs.pageIndex,pageSize:app.configs.pageSize},dataType:"json",beforeSend:function(){app.startLoading()},success:function(i){var u=$("#table-template").html(),r="";i.RowCount>0?($.each(i.ResultList,function(n,t){r+=Mustache.render(u,{CustomerName:t.CustomerName,Id:t.Id,Total:app.formatNumber(t.Total,0),PaymentMethod:h(t.PaymentMethod),DateCreated:app.dateTimeFormatJson(t.DateCreated),BillStatus:c(t.BillStatus)})}),$("#lbl-total-records").text(i.RowCount),r!=undefined&&$("#tbl-content").html(r),l(i.RowCount,function(){t()},n)):($("#lbl-total-records").text("0"),$("#tbl-content").html(""));app.stopLoading()},error:function(n){console.log(n)}})}function h(t){var i=$.grep(n.paymentMethods,function(n){return n.Value===t});return i.length>0?i[0].Name:""}function c(t){return t=$.grep(n.billStatuses,function(n){return n.Value===t}),t.length>0?t[0].Name:""}function l(n,t,i){var r=Math.ceil(n/app.configs.pageSize);($("#paginationUL a").length===0||i===!0)&&($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:r,visiblePages:7,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(n,i){app.configs.pageIndex=i;setTimeout(t(),200)}})}var n={products:[],paymentMethods:[],billStatuses:[]};this.initialize=function(){$.when(e(),o(),s()).done(function(){t()});f()}};