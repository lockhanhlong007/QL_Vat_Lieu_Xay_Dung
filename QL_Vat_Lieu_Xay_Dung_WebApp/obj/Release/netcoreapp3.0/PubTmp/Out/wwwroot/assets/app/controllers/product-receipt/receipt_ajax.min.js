var receipt_ajax=function(){function o(){$("#txtFromDate, #txtToDate").datepicker({autoclose:!0,format:"dd/mm/yyyy"});$("#frmMaintainance").validate({errorClass:"red",ignore:[],lang:"vi",rules:{ddlSupplierName:{required:!0},ddlReceiptStatus:{required:!0},txtOriginalPrice:{required:!0,integer:!0,min:0},txtQuantity:{required:!0,integer:!0,range:[0,100]}}});$("#txt-search-keyword").keypress(function(n){n.which===13&&(n.preventDefault(),t())});$("#btn-search").on("click",function(){t()});$("#btn-create").on("click",function(){e();$("#modal-detail").modal("show")});$("#ddl-show-page").on("change",function(){app.configs.pageSize=$(this).val();app.configs.pageIndex=1;t(!0)});$("body").on("click",".btn-view",function(n){n.preventDefault();var t=$(this).data("id");$.ajax({type:"GET",url:"/Admin/ProductReceipt/GetById",data:{id:t},beforeSend:function(){app.startLoading()},success:function(n){var t=n,e,i,o;$("#hidId").val(t.Id);$("#hidUserId").val(t.UserId);$("#hidDateCreated").val(t.DateCreated);$("#ddlReceiptStatus").val(t.ReceiptStatus);r(t.SupplierId);e=t.ProductReceiptDetails;t.ProductReceiptDetails!=null&&t.ProductReceiptDetails.length>0&&(i="",o=$("#template-table-receipt-details").html(),$.each(e,function(n,t){var r=u(t.ProductId),e=f(t.SizeId);i+=Mustache.render(o,{Id:t.Id,Products:r,Sizes:e,OriginalPrice:t.OriginalPrice,Quantity:t.Quantity})}),$("#tbl-receipt-details").html(i));$("#modal-detail").modal("show");app.stopLoading()},error:function(){app.notify("Has an error in progress","error");app.stopLoading()}})});$("#btnSave").on("click",function(n){if($("#frmMaintainance").valid()){n.preventDefault();var i=$("#hidId").val(),u=$("#hidUserId").val(),f=$("#ddlSupplierName").val(),o=$("#ddlReceiptStatus").val(),s=$("#hidDateCreated").val(),r=[];return $.each($("#tbl-receipt-details tr"),function(n,t){r.push({Id:$(t).data("id"),ProductId:$(t).find("select.ddlProductId").first().val(),Quantity:$(t).find("input.txtQuantity").first().val(),SizeId:$(t).find("select.ddlSizeId").first().val(),OriginalPrice:$(t).find("input.txtOriginalPrice").first().val(),ProductReceiptId:i})}),$.ajax({type:"POST",url:"/Admin/ProductReceipt/SaveEntity",data:{Id:i,SupplierId:f,UserId:u,DateCreated:s,ReceiptStatus:o,ProductReceiptDetails:r},dataType:"json",beforeSend:function(){app.startLoading()},success:function(){app.notify("Save order successful","success");$("#modal-detail").modal("hide");e();app.stopLoading();t(!0)},error:function(){app.notify("Has an error in progress","error");app.stopLoading()}}),!1}return!1});$("#btnAddDetail").on("click",function(){var n=$("#template-table-receipt-details").html(),t=u(null),i=f(null),r=Mustache.render(n,{Id:0,Products:t,Sizes:i,Quantity:0,OriginalPrice:0,Total:0});$("#tbl-receipt-details").append(r)});$("body").on("click",".btn-delete-detail",function(){$(this).parent().parent().remove()})}function i(){return $.ajax({type:"GET",url:"/admin/ProductReceipt/GetReceiptStatus",dataType:"json",success:function(t){n.receiptStatuses=t;var i="<option value = ''>=== Select Receipt Status ===<\/option>";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlReceiptStatus").html(i)}})}function s(){return $.ajax({type:"GET",url:"/Admin/Product/GetAll",dataType:"json",success:function(t){n.products=t},error:function(){app.notify("Has an error in progress","error")}})}function h(){return $.ajax({type:"GET",url:"/Admin/ProductReceipt/GetSizes",dataType:"json",success:function(t){n.sizes=t},error:function(){app.notify("Has an error in progress","error")}})}function r(n){$.ajax({type:"GET",url:"/Admin/Supplier/GetAll",dataType:"json",success:function(t){var i="<option value = ''>=== Select Supplier ===<\/option>";$.each(t,function(n,t){i+="<option value='"+t.Id+"'>"+t.FullName+"<\/option>"});$("#ddlSupplierName").html(i);n!=undefined&&$("#ddlSupplierName").val(n)},error:function(n){console.log(n);app.notify("Không thể tải danh mục nhà cung cấp","error")}})}function u(t){var i="<select required class='form-control ddlProductId'>";return i+="<option value = ''>=== Select Product ===<\/option>",$.each(n.products,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function f(t){var i="<select required class='form-control ddlSizeId'>";return i+="<option value = ''>=== Select Size ===<\/option>",$.each(n.sizes,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function e(){$("#hidId").val(0);var n=new Date,t=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();$("#hidDateCreated").val(t);$("#hidUserId").val("");r(null);i();$("#tbl-receipt-details").html("")}function t(n){$.ajax({type:"GET",url:"/admin/ProductReceipt/GetAllPaging",data:{startDate:$("#txtFromDate").val(),endDate:$("#txtToDate").val(),keyword:$("#txtSearchKeyword").val(),page:app.configs.pageIndex,pageSize:app.configs.pageSize},dataType:"json",beforeSend:function(){app.startLoading()},success:function(i){var u=$("#table-template").html(),r="";i.RowCount>0?($.each(i.ResultList,function(n,t){r+=Mustache.render(u,{Name:t.Supplier.FullName,Id:t.Id,Total:app.formatNumber(t.Total,0),DateCreated:app.dateTimeFormatJson(t.DateCreated),ReceiptStatus:c(t.ReceiptStatus)})}),$("#lbl-total-records").text(i.RowCount),r!=undefined&&$("#tbl-content").html(r),l(i.RowCount,function(){t()},n)):($("#lbl-total-records").text("0"),$("#tbl-content").html(""));app.stopLoading()},error:function(n){console.log(n)}})}function c(t){return t=$.grep(n.receiptStatuses,function(n){return n.Value===t}),t.length>0?t[0].Name:""}function l(n,t,i){var r=Math.ceil(n/app.configs.pageSize);($("#paginationUL a").length===0||i===!0)&&($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:r,visiblePages:7,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(n,i){app.configs.pageIndex=i;setTimeout(t(),200)}})}var n={products:[],sizes:[],receiptStatuses:[]};this.initialize=function(){$.when(i(),h(),s()).done(function(){t()});o()}};